<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ  å‡Œç¾¤ç¤¾å®… AI é¡§å•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #chat-box { height: calc(100vh - 240px); scrollbar-width: thin; }
        .message-bubble { max-width: 85%; word-wrap: break-word; line-height: 1.6; }
        .img-preview-box { width: 50px; height: 50px; object-fit: cover; border-radius: 6px; border: 2px solid #3b82f6; }
        /* è®“å°è©±ä¸­çš„åœ–ç‰‡ä¸è¦å¤ªå¤§ */
        .chat-img { max-width: 200px; border-radius: 12px; margin-bottom: 8px; cursor: pointer; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">

    <header class="bg-blue-900 text-white p-4 text-center shadow-md flex-shrink-0">
        <h1 class="text-xl font-bold tracking-tight">å‡Œç¾¤ç¤¾å®… AI é¡§å•</h1>
        <p id="model-status" class="text-xs text-blue-200 mt-1 italic font-mono">æ­£åœ¨åˆå§‹åŒ–æ™ºæ…§ç³»çµ±...</p>
    </header>

    <main id="chat-box" class="flex-1 p-4 space-y-4 overflow-y-auto">
        <div class="flex justify-start">
            <div class="bg-white border p-3 rounded-2xl rounded-tl-none shadow-sm message-bubble text-gray-700">
                ç³»çµ±å·²å°±ç·’ï¼æ‚¨å¯ä»¥ç›´æ¥æ‹ç…§ä¸Šå‚³ç§Ÿç´„ã€ä¿®ç¹•ç…§ç‰‡ï¼Œæˆ–è©¢å•ä»»ä½•ç¤¾å®…ç›¸é—œå•é¡Œã€‚
            </div>
        </div>
    </main>

    <div id="preview-area" class="hidden px-4 py-2 bg-white border-t flex items-center gap-3">
        <div class="relative">
            <img id="img-display" src="" class="img-preview-box">
            <button onclick="clearImage()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center">âœ•</button>
        </div>
        <span class="text-xs text-gray-500 italic">åœ–ç‰‡å·²å°±ç·’ï¼Œæº–å‚™åˆ†æ...</span>
    </div>

    <footer class="p-4 bg-white border-t shadow-inner flex-shrink-0">
        <div class="max-w-4xl mx-auto flex gap-2 items-end">
            <label class="cursor-pointer bg-gray-100 hover:bg-gray-200 p-3 rounded-full transition-all border border-gray-200 mb-1">
                <span class="text-xl">ğŸ“·</span>
                <input type="file" id="image-input" class="hidden" accept="image/*" onchange="handleFile(this)">
            </label>
            
            <div class="flex-1 relative">
                <textarea id="user-input" rows="1" 
                    class="w-full border border-gray-300 rounded-2xl px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 resize-none overflow-hidden"
                    placeholder="è¼¸å…¥è¨Šæ¯..."
                    oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                    onkeypress="if(event.keyCode==13 && !event.shiftKey) { event.preventDefault(); sendMsg(); }"></textarea>
            </div>

            <button onclick="sendMsg()" class="bg-blue-700 hover:bg-blue-800 text-white font-bold px-6 py-3 rounded-2xl shadow-md transition-all active:scale-95 mb-1">
                ç™¼é€
            </button>
        </div>
    </footer>

    <script>
        const GEMINI_API_KEY = "AIzaSyAQkaFEQRJEIVgw82_vSrbXgoM35W3B9Gg";
        let activeModel = "";
        let currentImageBase64 = null;

        // åˆå§‹åŒ–ï¼šè‡ªå‹•åµæ¸¬å¯ç”¨æ¨¡å‹
        async function detectModel() {
            const statusBox = document.getElementById('model-status');
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${GEMINI_API_KEY}`);
                const data = await res.json();
                const model = data.models.find(m => m.supportedGenerationMethods.includes("generateContent") && m.name.includes("flash"));
                if (model) {
                    activeModel = model.name;
                    statusBox.innerText = `â— ç³»çµ±åœ¨ç·š (${activeModel.split('/').pop()})`;
                    statusBox.className = "text-xs text-green-400 mt-1 font-mono";
                }
            } catch (e) {
                statusBox.innerText = "â— é€£ç·šç•°å¸¸ï¼Œè«‹æª¢æŸ¥ç¶²è·¯";
                statusBox.className = "text-xs text-red-400 mt-1 font-mono";
            }
        }
        detectModel();

        // è™•ç†åœ–ç‰‡é¸æ“‡ä¸¦é¡¯ç¤ºç¸®åœ–
        function handleFile(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentImageBase64 = e.target.result;
                    document.getElementById('img-display').src = currentImageBase64;
                    document.getElementById('preview-area').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        // æ¸…é™¤åœ–ç‰‡
        function clearImage() {
            currentImageBase64 = null;
            document.getElementById('image-input').value = '';
            document.getElementById('preview-area').classList.add('hidden');
        }

        async function sendMsg() {
            const input = document.getElementById('user-input');
            const chatBox = document.getElementById('chat-box');
            const msg = input.value.trim();
            
            if (!msg && !currentImageBase64) return;
            if (!activeModel) { alert("ç³»çµ±åˆå§‹åŒ–ä¸­ï¼Œè«‹ç¨å€™..."); return; }

            // 1. åœ¨å°è©±ä¸­é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯èˆ‡åœ–ç‰‡
            let userHTML = `<div class="flex justify-end"><div class="bg-blue-600 text-white p-3 rounded-2xl rounded-tr-none shadow-md message-bubble flex flex-col items-end">`;
            if (currentImageBase64) {
                userHTML += `<img src="${currentImageBase64}" class="chat-img shadow-sm border border-blue-400">`;
            }
            if (msg) userHTML += `<span>${msg}</span>`;
            userHTML += `</div></div>`;
            chatBox.innerHTML += userHTML;
            
            const tempMsg = msg || "è«‹è©³ç´°åˆ†æé€™å¼µåœ–ç‰‡å…§å®¹ã€‚";
            const tempImg = currentImageBase64;
            
            // é‡ç½®è¼¸å…¥å€åŸŸ
            input.value = '';
            input.style.height = 'auto';
            clearImage();
            chatBox.scrollTop = chatBox.scrollHeight;

            // 2. é¡¯ç¤ºæ€è€ƒç‹€æ…‹
            const loadingId = "load-" + Date.now();
            chatBox.innerHTML += `<div id="${loadingId}" class="flex justify-start text-gray-400 text-sm animate-pulse italic">AI æ­£åœ¨æ€è€ƒä¸­...</div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const payload = { contents: [{ parts: [{ text: tempMsg }] }] };
                if (tempImg) {
                    payload.contents[0].parts.push({
                        inline_data: { mime_type: "image/jpeg", data: tempImg.split(',')[1] }
                    });
                }

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${activeModel}:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                document.getElementById(loadingId).remove();

                const reply = data.candidates[0].content.parts[0].text;
                chatBox.innerHTML += `
                    <div class="flex justify-start">
                        <div class="bg-white border border-gray-200 p-3 rounded-2xl rounded-tl-none shadow-sm message-bubble text-gray-800">
                            ${reply.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                `;
            } catch (e) {
                if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
                chatBox.innerHTML += `<div class="text-red-500 text-xs text-center">é€£ç·šä¸­æ–·ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</div>`;
                console.error(e);
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
</body>
</html>

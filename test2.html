<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ  å‡Œç¾¤ç¤¾å®… AI (è‡ªå‹•åµæ¸¬ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #chat-box { height: calc(100vh - 220px); overflow-y: auto; }
        .message-bubble { max-width: 85%; word-wrap: break-word; }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col">

    <header class="bg-blue-900 text-white p-4 text-center shadow-md">
        <h1 class="text-xl font-bold">å‡Œç¾¤ç¤¾å®… AI é¡§å•</h1>
        <p id="model-status" class="text-xs text-blue-200 mt-1">æ­£åœ¨åµæ¸¬å¯ç”¨æ¨¡å‹...</p>
    </header>

    <main id="chat-box" class="flex-1 p-4 space-y-4 bg-slate-50"></main>

    <footer class="p-4 bg-white border-t">
        <div class="max-w-4xl mx-auto flex gap-2">
            <input type="file" id="image-input" class="hidden" accept="image/*" onchange="handleFile(this)">
            <button onclick="document.getElementById('image-input').click()" class="p-3 bg-gray-100 rounded-full">ğŸ“·</button>
            <input type="text" id="user-input" class="flex-1 border rounded-full px-4" placeholder="è«‹è¼¸å…¥è¨Šæ¯...">
            <button onclick="sendMsg()" class="bg-blue-700 text-white px-6 py-2 rounded-full">ç™¼é€</button>
        </div>
    </footer>

    <script>
        const GEMINI_API_KEY = "AIzaSyAQkaFEQRJEIVgw82_vSrbXgoM35W3B9Gg";
        let activeModel = ""; // è‡ªå‹•åµæ¸¬å¾Œå¡«å…¥
        let currentImageBase64 = null;

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šè‡ªå‹•åµæ¸¬é€™æŠŠ Key æ”¯æ´å“ªå€‹æ¨¡å‹ ---
        async function detectModel() {
            const statusBox = document.getElementById('model-status');
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${GEMINI_API_KEY}`);
                const data = await res.json();
                
                // æ‰¾å‡ºæ”¯æ´ generateContent çš„ç¬¬ä¸€å€‹æ¨¡å‹ (å„ªå…ˆæ‰¾ flash)
                const model = data.models.find(m => m.supportedGenerationMethods.includes("generateContent") && m.name.includes("flash"));
                
                if (model) {
                    activeModel = model.name; // æ ¼å¼å¦‚ "models/gemini-1.5-flash"
                    statusBox.innerText = `é€£ç·šæˆåŠŸï¼šå·²åµæ¸¬åˆ° ${activeModel}`;
                    statusBox.className = "text-xs text-green-300 mt-1";
                } else {
                    throw new Error("æ‰¾ä¸åˆ°å¯ç”¨æ¨¡å‹");
                }
            } catch (e) {
                statusBox.innerText = "åµæ¸¬å¤±æ•—ï¼šè«‹ç¢ºèª API Key æ¬Šé™";
                statusBox.className = "text-xs text-red-400 mt-1";
            }
        }

        // é é¢è¼‰å…¥å¾Œå…ˆåµæ¸¬
        detectModel();

        function handleFile(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => currentImageBase64 = e.target.result;
                reader.readAsDataURL(file);
                alert("åœ–ç‰‡å·²è®€å–");
            }
        }

        async function sendMsg() {
            if (!activeModel) { alert("æ¨¡å‹å°šæœªå°±ç·’ï¼Œè«‹ç¨å€™"); return; }
            
            const input = document.getElementById('user-input');
            const chatBox = document.getElementById('chat-box');
            const msg = input.value.trim();
            if (!msg && !currentImageBase64) return;

            // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
            chatBox.innerHTML += `<div class="flex justify-end"><div class="bg-blue-600 text-white p-3 rounded-xl">${msg || "åœ–ç‰‡åˆ†æ"}</div></div>`;
            
            const tempMsg = msg || "è«‹åˆ†æåœ–ç‰‡";
            const tempImg = currentImageBase64;
            input.value = '';
            currentImageBase64 = null;

            try {
                const payload = {
                    contents: [{ parts: [{ text: tempMsg }] }]
                };

                if (tempImg) {
                    payload.contents[0].parts.push({
                        inline_data: { mime_type: "image/jpeg", data: tempImg.split(',')[1] }
                    });
                }

                // ä½¿ç”¨è‡ªå‹•åµæ¸¬åˆ°çš„è·¯å¾‘
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${activeModel}:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                const reply = data.candidates[0].content.parts[0].text;

                chatBox.innerHTML += `<div class="flex justify-start"><div class="bg-white border p-3 rounded-xl">${reply.replace(/\n/g, '<br>')}</div></div>`;
            } catch (e) {
                chatBox.innerHTML += `<div class="text-red-500 text-xs text-center">ç™¼é€å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚</div>`;
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
</body>
</html>
